<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/antlir/blog/rss.xml" title="Antlir Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/antlir/blog/atom.xml" title="Antlir Blog Atom Feed"><title data-react-helmet="true">Version Selection | Antlir</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Version Selection | Antlir"><meta data-react-helmet="true" name="description" content="Constraining allowable package versions"><meta data-react-helmet="true" property="og:description" content="Constraining allowable package versions"><meta data-react-helmet="true" property="og:url" content="https://facebookincubator.github.io/antlir/antlir/docs/concepts/rpms/version-selection"><link data-react-helmet="true" rel="shortcut icon" href="/antlir/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://facebookincubator.github.io/antlir/antlir/docs/concepts/rpms/version-selection"><link rel="stylesheet" href="/antlir/styles.e975dfe0.css">
<link rel="preload" href="/antlir/styles.1e52b388.js" as="script">
<link rel="preload" href="/antlir/runtime~main.0ba2ed7f.js" as="script">
<link rel="preload" href="/antlir/main.cce518cc.js" as="script">
<link rel="preload" href="/antlir/1.b2a8c866.js" as="script">
<link rel="preload" href="/antlir/2.040d89d0.js" as="script">
<link rel="preload" href="/antlir/47.6ec8709e.js" as="script">
<link rel="preload" href="/antlir/48.5ce53919.js" as="script">
<link rel="preload" href="/antlir/935f2afb.2610b145.js" as="script">
<link rel="preload" href="/antlir/17896441.0dad034a.js" as="script">
<link rel="preload" href="/antlir/b0f7b9cd.e39ba721.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/antlir/"><img src="/antlir/img/logo.svg" alt="My Facebook Project Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/antlir/img/logo.svg" alt="My Facebook Project Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Antlir</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/antlir/docs/">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/antlir" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/antlir/"><img src="/antlir/img/logo.svg" alt="My Facebook Project Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/antlir/img/logo.svg" alt="My Facebook Project Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Antlir</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/antlir/docs/">Docs</a></li><li class="menu__list-item"><a href="https://github.com/facebookincubator/antlir" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/antlir/docs/">Overview</a></li><li class="menu__list-item"><a class="menu__link" href="/antlir/docs/getting_started">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" href="/antlir/docs/faq">FAQ</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#!">Tutorials</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/antlir/docs/tutorials/defining-an-image">Defining an Image</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/antlir/docs/tutorials/helper-buck-targets">Helper Buck Targets</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Concepts &amp; Design</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!" tabindex="0">RPMs</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/antlir/docs/concepts/rpms/overview">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/antlir/docs/concepts/rpms/how-rpms-are-updated">How RPMs are Updated</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/antlir/docs/concepts/rpms/using-rpms-in-images">Using RPMs in Images</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/antlir/docs/concepts/rpms/version-selection">Version Selection</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">Pre-built Artifacts</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/antlir/docs/concepts/pre-built-artifacts/fetched-artifacts">Fetched Artifacts</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">Flavors</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/antlir/docs/concepts/flavors/overview">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/antlir/docs/concepts/flavors/inheritance-in-parent-layers">Inheritance in Parent Layers</a></li></ul></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#!">API</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/antlir/docs/api/image">Image</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/antlir/docs/genrule-layer">image.genrule_layer</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">nspawn Runtime</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/antlir/docs/runtime/nspawn-runtime/image-unittest">image.*_unittest</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">VM Runtime</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/antlir/docs/runtime/vm-runtime/vm-unittest">vm.*_unittest</a></li></ul></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/antlir/docs/api/shape">Shape</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/antlir/docs/api/flavor_helpers">Flavor_helpers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/antlir/docs/api/test_rpms">Test_rpms</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Contributing</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Coding Conventions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/antlir/docs/contributing/coding-conventions/bzl-and-targets">.bzl and TARGETS</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/antlir/docs/contributing/coding-conventions/pyre">Pyre</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/antlir/docs/contributing/coding-conventions/python">Python</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">TODOs</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/antlir/docs/contributing/todos/btrfs_diff">btrfs_diff/</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/antlir/docs/contributing/todos/compiler">compiler/</a></li></ul></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/antlir/docs/installing">Installation</a></li><li class="menu__list-item"><a class="menu__link" href="/antlir/docs/oss-test-runner">Test Runner</a></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Version Selection</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="constraining-allowable-package-versions"></a>Constraining allowable package versions<a class="hash-link" href="#constraining-allowable-package-versions" title="Direct link to heading">#</a></h2><p>Image builds
<a href="/antlir/docs/concepts/rpms/overview#rpms-come-from-snapshots">install RPMs from repo snapshots</a>.
These snapshots sometimes contain broken or bleeding-edge versions of packages.</p><p>We maintain automation, which periodically commits lists of allowable versions
to fbcode for each <em>package group</em>, by evaluating a <em>version policy</em> for the
group. To address the fact that different applications may call for different
package version mixes, fbcode may contain multiple named <em>version sets</em>, each
picking different version policies. The italicized concepts are thoroughly
explained below.</p><p>Versions for packages not included in any group will be whatever <code>yum</code> / <code>dnf</code>
select, which is usually &quot;latest&quot; or &quot;whatever is required by the package that
depends on it&quot;.</p><p><strong>IMPORTANT:</strong> Allowable versions for a package <strong>ONLY</strong> apply if your
<code>image.layer</code> explicitly installs that package. So if your layer installs X,
which depends on Y, and both have a version policy, the version policy for Y
will only apply if your layer also explicitly installs Y. Otherwise, your
version of X will be per policy, and Y will be whatever <code>yum</code> / <code>dnf</code> decide
(i.e. latest acceptable per X&#x27;s dependency spec). There&#x27;s a
<a href="#why-do-we-only-control-versions-for-explicitly-named-packages">later section</a>
explaining this rule.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="concepts"></a>Concepts<a class="hash-link" href="#concepts" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="package-group-universe-etc"></a>Package group, Universe, etc.<a class="hash-link" href="#package-group-universe-etc" title="Direct link to heading">#</a></h3><p>Start by reading <a href="/antlir/docs/concepts/rpms/overview">the overview</a>.</p><p>Package groups can be defined: manually, or via slowroll:</p><ul><li><code>&quot;packages&quot;: [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]</code></li><li><code>&quot;packages&quot;: {&quot;source&quot;: &quot;slowroll&quot;, &quot;name&quot;: &quot;systemd-packages&quot;}</code> â€” this only
works for multi-package slowrolls.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="version-policy"></a>Version policy<a class="hash-link" href="#version-policy" title="Direct link to heading">#</a></h3><p>For a package group, a policy examines the versions available in the RPM
snapshot, and looks at some other data source to pick the versions (possibly
plural!) to allow installing into images. Available policies:</p><ul><li><p>A manual version spec: :</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   &quot;policy&quot;: &quot;manual&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   &quot;versions&quot;: {&quot;x86_64&quot;: [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;VERSION1-RELEASE1&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {&quot;epoch&quot;: 3, &quot;version&quot;: &quot;VER2&quot;, &quot;release&quot;: &quot;REL2&quot;},</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   ]}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>For each architecture, allows only the specified RPM epoch-version-releases to
be installed for your package group. If you use the &quot;version-release&quot;
shorthand, we try to will resolve the epoch from the RPM snapshot, and error
if more than one package matches. You can specify additional architectures,
e.g. <code>i686</code> is how we handle 32-bit binary support on CentOS7.</p><p>The architecture can be the wildcard (<code>&quot;*&quot;</code>). Then RPMs of any architecture
will pass version-selection criterion if epoch-version-release (or
version-release shorthand if any) matches.</p></li></ul><p>It is an error if none of the versions suggested by a policy are available in
the snapshot.</p><p>When a policy encounters an error for a package, the package will &quot;fail open&quot;,
allowing the installation of any version. This behavior is deliberate â€” there is
no value in preserving a stale version-lock, so we might as well have the diff
check whether trunk now works without locks. The automatic diff description will
suggest updating or deleting the corresponding package group policy to allow
installing any version from the repo snapshot.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="version-set"></a>Version set<a class="hash-link" href="#version-set" title="Direct link to heading">#</a></h3><p>We may want to build several flavors of images, with more or less well-tested
package mixes. Every image is built using allowable versions from a specific
version set name. The currently available names are:</p><ul><li><code>tw_jobs</code>: Versions stable enough to safely include in a normal release
process for a Tupperware job â€” e.g. a Conveyor / SF canary, followed by a
gradual failure-reverting job update to use the new packages. Although each
job owner is responsible for testing your job, avoid shipping something so
unvetted that it will break push for many teams at once. This version set is
not directly related to Slowroll <code>&quot;stable&quot;</code> â€” see
<a href="https://our.intern.facebook.com/intern/wiki/Production_Engineering/OS/Slowroll/SlowrolledRPMsAndTW/#can-we-just-use-slowroll" target="_blank" rel="noopener noreferrer">this section</a>
for why using Slowroll versions outside of Chef makes no sense.</li></ul><p>If a package group does not set a policy for a particular version set, any
version in the RPM snapshot may be installed.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="how-do-i-define-a-policy-for-my-packages"></a>How do I define a policy for my packages?<a class="hash-link" href="#how-do-i-define-a-policy-for-my-packages" title="Direct link to heading">#</a></h2><p>Decide whether your policy is specific for a flavor or it&#x27;s good for all
flavors. In the former case your <code>package_groups</code> directory will be
<code>fbcode/antlir/rpm/allowed_versions/facebook/package_groups/&lt;flavor&gt;/</code>,
in the latter case:
<code>fbcode/antlir/rpm/allowed_versions/facebook/package_groups/</code></p><p>Add <code>YOUR_GROUPNAME.json</code> into your <code>package_groups</code> directory with the
following information:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ jq -C . systemd.json</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;packages&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   &quot;source&quot;: &quot;slowroll&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   &quot;name&quot;: &quot;systemd-packages&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">},</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;version_set_to_policy&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   &quot;tw_jobs&quot;: &quot;slowroll&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">},</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;oncall&quot;: &quot;systemd_releng&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The <code>&quot;packages&quot;</code> field is documented above â€” for single-package slowrolls, you
should just specify <code>&quot;packages&quot;: [&quot;rpm-name&quot;]</code>.</p><p>Available policies &amp; version set names are also documented above.</p><p>Suggested auto-formatting is
<code>name=YOUR_FILE.json cfg=&quot;$(cat &quot;$name&quot;)&quot; ; echo &quot;$cfg&quot; | jq . &gt; &quot;$name&quot;</code>.
Whether for formatting, or for data model changes, we may modify your policy
files without warning, while aiming to preserve their intent.</p><p>Update version files for each flavor affected:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ buck run antlir/rpm/allowed_versions:update-allowed-versions -- \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --no-update-data-snapshot \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --flavor centos8 \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --data-snapshot-dir antlir/rpm/allowed_versions/facebook/snapshot/centos8 \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --package-groups-dir antlir/rpm/allowed_versions/facebook/package_groups \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --package-groups-dir antlir/rpm/allowed_versions/facebook/package_groups/centos8 \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --version-sets-dir bot_generated/antlir/version_sets/centos8 \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --rpm-repo-snapshot $(buck build antlir/rpm/facebook:centos8 --show-full-output | cut -d &#x27; &#x27; -f2)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ buck run antlir/rpm/allowed_versions:update-allowed-versions -- \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --no-update-data-snapshot \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --flavor centos7 \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --data-snapshot-dir antlir/rpm/allowed_versions/facebook/snapshot/centos7 \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --package-groups-dir antlir/rpm/allowed_versions/facebook/package_groups \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --package-groups-dir antlir/rpm/allowed_versions/facebook/package_groups/centos7 \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --version-sets-dir bot_generated/antlir/version_sets/centos7 \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --rpm-repo-snapshot $(buck build antlir/rpm/facebook:centos7 --show-full-output | cut -d &#x27; &#x27; -f2)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>At this point you can manually inspect updated version files (they are in
<code>bot_generated/antlir/version_sets/&lt;flavor&gt;/tw_jobs/rpm/&lt;oncall&gt;/</code>) to see that
they have proper ENVRAs and rebuild image layers locally for testing purposes.</p><p>Put up a diff with your policy and version files, then <strong>wait for tests to be
green</strong>.</p><p>Once your policy and version files are committed, automation will begin
regenerating a preferred version for your package group.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="what-happens-when-a-version-updates"></a>What happens when a version updates?<a class="hash-link" href="#what-happens-when-a-version-updates" title="Direct link to heading">#</a></h2><p>Your oncall will see a diff that updates a file in fbcode to contain the new
allowable versions for you package group. Automation will land this diff is all
builds &amp; tests are green. Otherwise, your oncall is responsible for ensuring
that the builds &amp; tests <strong>become</strong> green. On-diff failures typically indicate
that your version bump broke somebody. Talk to that team, they&#x27;ll be eager to
help you fix them.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="how-often-do-versions-update"></a>How often do versions update?<a class="hash-link" href="#how-often-do-versions-update" title="Direct link to heading">#</a></h2><p>We refresh versions more often than we generate RPM repo snapshots. The exact
frequencies are subject to change, but snapshots will be ~1/week, and version
refreshes will happen every couple of hours (limited by fbcode diff turnaround
time).</p><p>However in some cases, a policy would only be able to pick versions that
are not yet in the snapshot.</p><p>In these cases, the version bump will be delayed until the next RPM snapshot.</p><p>The practical rationale for the differing update frequencies is that testing a
version bump is cheap, because Buck knows the full dependency graph for these.
Testing a new snapshot involves rebuilding &amp; retesting the world.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="how-do-allowable-versions-affect-buck-dependencies"></a>How do allowable versions affect Buck dependencies?<a class="hash-link" href="#how-do-allowable-versions-affect-buck-dependencies" title="Direct link to heading">#</a></h2><p>Every <code>image.layer</code> that installs any RPMs depends on an RPM repo snapshot
(normally, this is specified via the <code>build_appliance</code> field, formerly we used
<code>yum_from_repo_snapshot</code>).</p><p>So, updating the snapshot rebuilds the world, which is expensive in terms of
Sandcastle capacity.</p><p>In contrast, each package&#x27;s &quot;allowable versions&quot; list is a separate target, and
your <code>image.layer</code> only depends on the targets for RPMs it explicitly installs.</p><p>So, changing the version of a package (while leaving the snapshot fixed) will
only rebuild those images that explicitly install the package.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="why-do-we-only-control-versions-for-explicitly-named-packages"></a>Why do we only control versions for explicitly named packages?<a class="hash-link" href="#why-do-we-only-control-versions-for-explicitly-named-packages" title="Direct link to heading">#</a></h2><p>It seems pretty counterintuitive that for packages that are pulled in as
dependencies, we go with &quot;whatever <code>yum</code> / <code>dnf</code> wants&quot; <strong>even when</strong> we know
the subset of &quot;better tested&quot; versions for those packages.</p><p>We have a handful of reasons for having implicit versions be less locked down:</p><ul><li><strong>[most important]</strong> We need package version bumps to be efficient in terms
of Sandcastle capacity. This means only rebuilding images that are actually
affected by the version bump. Buck currently does not know the dependency
structure of RPMs, which means that we can only have efficient re-builds if
version locks only affect those packages explicitly listed in <code>TARGETS</code>
files. If version locks also affected implicitly installed packages, then
any version bump would need to rebuild the world, which means that we would
only be able to update versions at the time that we do repo snapshots, which
is probably not what most teams want. We have a work item to try to expose
the RPM dependency structure to Buck, which would enable more frequent
snapshots, but I do not want to block the version selection work on that
substantial effort. See &quot;Map RPM dependencies onto Buck dependencies for
efficient rebuilds on RPM updates&quot; in <a href="https://fb.quip.com/YR5sAUGA74lc" target="_blank" rel="noopener noreferrer">https://fb.quip.com/YR5sAUGA74lc</a>.</li><li>It is completely plausible to lock down implicitly installed packages at a
later date, if it proves to be a problem.</li><li>If the latest &quot;Y&quot; is pulled in as a dependency of X, and the author of X is
not satisfied with the version of &quot;Y&quot;, then the dependency spec for X is
wrong. We should be fixing these types of issues at the package level.</li><li>Reducing the number of locked versions will generally reduce the operational
headaches with resolving dependency conflicts.</li><li><strong>[technicality]</strong> This mirrors Chef&#x27;s behavior, in the sense that if
package <code>X</code> depends on <code>Y</code>, and both have slowrolls in recipes <code>rX</code> and
<code>rY</code>, and somehow only <code>rX</code> is executed on your Chef run (i.e. <code>rX</code> does not
explicitly depend on <code>rY</code>), then you will end up with <code>X</code> slowrolled, but
<code>Y</code> unmanaged.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="future-some-version-locks-are-part-of-the-snapshot-apply-always"></a>Future: some version-locks are part of the snapshot, apply always<a class="hash-link" href="#future-some-version-locks-are-part-of-the-snapshot-apply-always" title="Direct link to heading">#</a></h2><p>There is a narrow use-case, where the &quot;latest&quot; version in a repo snapshot is
bad, and the breakage on hosts was mitigated using Slowroll or Chef.
Specifically, this handles the &quot;accidental VIM upgrade&quot; scenario, where <code>vim</code>
went to 8.0 before FB was ready for it.</p><p>For these, we&#x27;ll want a separate version-lock file that is part of the snapshot,
and that applies even to implicitly installed packages.</p><p>This is not hard to build, but we are not prioritizing it yet.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebookincubator/antlir/edit/master/website/docs/concepts/rpms/version-selection.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/antlir/docs/concepts/rpms/using-rpms-in-images"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Using RPMs in Images</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/antlir/docs/concepts/pre-built-artifacts/fetched-artifacts"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Fetched Artifacts Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#constraining-allowable-package-versions" class="table-of-contents__link">Constraining allowable package versions</a></li><li><a href="#concepts" class="table-of-contents__link">Concepts</a><ul><li><a href="#package-group-universe-etc" class="table-of-contents__link">Package group, Universe, etc.</a></li><li><a href="#version-policy" class="table-of-contents__link">Version policy</a></li><li><a href="#version-set" class="table-of-contents__link">Version set</a></li></ul></li><li><a href="#how-do-i-define-a-policy-for-my-packages" class="table-of-contents__link">How do I define a policy for my packages?</a></li><li><a href="#what-happens-when-a-version-updates" class="table-of-contents__link">What happens when a version updates?</a></li><li><a href="#how-often-do-versions-update" class="table-of-contents__link">How often do versions update?</a></li><li><a href="#how-do-allowable-versions-affect-buck-dependencies" class="table-of-contents__link">How do allowable versions affect Buck dependencies?</a></li><li><a href="#why-do-we-only-control-versions-for-explicitly-named-packages" class="table-of-contents__link">Why do we only control versions for explicitly named packages?</a></li><li><a href="#future-some-version-locks-are-part-of-the-snapshot-apply-always" class="table-of-contents__link">Future: some version-locks are part of the snapshot, apply always</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Learn</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/antlir/docs/">Documentation</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/antlir" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/antlir" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noreferrer noopener" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noreferrer noopener" class="footer__link-item">Terms</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_31Aa"><img class="footer__logo" alt="Facebook Open Source Logo" src="/antlir/img/oss_logo.png"></a></div><div class="footer__copyright">Copyright Â© 2021 Facebook, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/antlir/styles.1e52b388.js"></script>
<script src="/antlir/runtime~main.0ba2ed7f.js"></script>
<script src="/antlir/main.cce518cc.js"></script>
<script src="/antlir/1.b2a8c866.js"></script>
<script src="/antlir/2.040d89d0.js"></script>
<script src="/antlir/47.6ec8709e.js"></script>
<script src="/antlir/48.5ce53919.js"></script>
<script src="/antlir/935f2afb.2610b145.js"></script>
<script src="/antlir/17896441.0dad034a.js"></script>
<script src="/antlir/b0f7b9cd.e39ba721.js"></script>
</body>
</html>