(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{113:function(t,e,n){"use strict";n.d(e,"a",(function(){return f})),n.d(e,"b",(function(){return m}));var r=n(0),i=n.n(r);function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function a(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function u(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?a(Object(n),!0).forEach((function(e){o(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function c(t,e){if(null==t)return{};var n,r,i=function(t,e){if(null==t)return{};var n,r,i={},o=Object.keys(t);for(r=0;r<o.length;r++)n=o[r],e.indexOf(n)>=0||(i[n]=t[n]);return i}(t,e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);for(r=0;r<o.length;r++)n=o[r],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(i[n]=t[n])}return i}var s=i.a.createContext({}),l=function(t){var e=i.a.useContext(s),n=e;return t&&(n="function"==typeof t?t(e):u(u({},e),t)),n},f=function(t){var e=l(t.components);return i.a.createElement(s.Provider,{value:e},t.children)},d={inlineCode:"code",wrapper:function(t){var e=t.children;return i.a.createElement(i.a.Fragment,{},e)}},p=i.a.forwardRef((function(t,e){var n=t.components,r=t.mdxType,o=t.originalType,a=t.parentName,s=c(t,["components","mdxType","originalType","parentName"]),f=l(n),p=r,m=f["".concat(a,".").concat(p)]||f[p]||d[p]||o;return n?i.a.createElement(m,u(u({ref:e},s),{},{components:n})):i.a.createElement(m,u({ref:e},s))}));function m(t,e){var n=arguments,r=e&&e.mdxType;if("string"==typeof t||r){var o=n.length,a=new Array(o);a[0]=p;var u={};for(var c in e)hasOwnProperty.call(e,c)&&(u[c]=e[c]);u.originalType=t,u.mdxType="string"==typeof t?t:r,a[1]=u;for(var s=2;s<o;s++)a[s]=n[s];return i.a.createElement.apply(null,a)}return i.a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},121:function(t,e,n){"use strict";n.r(e),n.d(e,"default",(function(){return i})),n.d(e,"useAllPluginInstancesData",(function(){return o})),n.d(e,"usePluginData",(function(){return a}));var r=n(22);function i(){var t=Object(r.default)().globalData;if(!t)throw new Error("Docusaurus global data not found");return t}function o(t){var e=i()[t];if(!e)throw new Error("Docusaurus plugin global data not found for pluginName="+t);return e}function a(t,e){void 0===e&&(e="default");var n=o(t)[e];if(!n)throw new Error("Docusaurus plugin global data not found for pluginName="+t+" and pluginId="+e);return n}},125:function(t,e){var n,r,i=t.exports={};function o(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function u(t){if(n===setTimeout)return setTimeout(t,0);if((n===o||!n)&&setTimeout)return n=setTimeout,setTimeout(t,0);try{return n(t,0)}catch(e){try{return n.call(null,t,0)}catch(e){return n.call(this,t,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:o}catch(t){n=o}try{r="function"==typeof clearTimeout?clearTimeout:a}catch(t){r=a}}();var c,s=[],l=!1,f=-1;function d(){l&&c&&(l=!1,c.length?s=c.concat(s):f=-1,s.length&&p())}function p(){if(!l){var t=u(d);l=!0;for(var e=s.length;e;){for(c=s,s=[];++f<e;)c&&c[f].run();f=-1,e=s.length}c=null,l=!1,function(t){if(r===clearTimeout)return clearTimeout(t);if((r===a||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(t);try{r(t)}catch(e){try{return r.call(null,t)}catch(e){return r.call(this,t)}}}(t)}}function m(t,e){this.fun=t,this.array=e}function b(){}i.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)e[n-1]=arguments[n];s.push(new m(t,e)),1!==s.length||l||u(p)},m.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=b,i.addListener=b,i.once=b,i.off=b,i.removeListener=b,i.removeAllListeners=b,i.emit=b,i.prependListener=b,i.prependOnceListener=b,i.listeners=function(t){return[]},i.binding=function(t){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(t){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},160:function(t,e,n){(function(e){const r=["internal","external"];let i;try{i=n(121).usePluginData}catch(c){i=null}function o(t){return function(t){if("object"!=typeof t)throw new Error(`fbContent() args must be an object containing keys: ${r}. Instead got ${t}`);if(!Object.keys(t).find((t=>r.find((e=>e===t)))))throw new Error(`No valid args found in ${JSON.stringify(t)}. Accepted keys: ${r}`);const e=Object.keys(t).filter((t=>!r.find((e=>e===t))));if(e.length>0)throw new Error(`Unexpected keys ${e} found in fbContent() args. Accepted keys: ${r}`)}(t),u()?"internal"in t?a(t.internal):[]:"external"in t?a(t.external):[]}function a(t){return"function"==typeof t?t():t}function u(){return e.env.FB_INTERNAL||i&&i("internaldocs-fb").FB_INTERNAL}t.exports={fbContent:o,fbInternalOnly:function(t){return o({internal:t})},isInternal:u,FbInternalOnly:function(t){return u()?t.children:null},OssOnly:function(t){return u()?null:t.children}}}).call(this,n(125))},89:function(t,e,n){"use strict";n.r(e),n.d(e,"frontMatter",(function(){return u})),n.d(e,"metadata",(function(){return c})),n.d(e,"toc",(function(){return s})),n.d(e,"default",(function(){return f}));var r=n(3),i=n(7),o=(n(0),n(113)),a=n(160),u={id:"vm-unittest",title:"vm.*_unittest"},c={unversionedId:"runtime/vm-runtime/vm-unittest",id:"runtime/vm-runtime/vm-unittest",isDocsHomePage:!1,title:"vm.*_unittest",description:"vmtest is a framework to run {cpp,rust,python}_unittests inside a",source:"@site/docs/runtime/vm-runtime/vm-unittest.mdx",slug:"/runtime/vm-runtime/vm-unittest",permalink:"/antlir/docs/runtime/vm-runtime/vm-unittest",editUrl:"https://github.com/facebookincubator/antlir/edit/master/website/docs/runtime/vm-runtime/vm-unittest.mdx",version:"current",sidebar:"docs",previous:{title:"image.*_unittest",permalink:"/antlir/docs/runtime/nspawn-runtime/image-unittest"},next:{title:"Shape",permalink:"/antlir/docs/api/shape"}},s=[{value:"Implementation Details",id:"implementation-details",children:[{value:"Root FS",id:"root-fs",children:[]},{value:"Guest connection",id:"guest-connection",children:[]},{value:"Guest-&gt;host boot notification",id:"guest-host-boot-notification",children:[]}]}],l={toc:s};function f(t){var e=t.components,n=Object(i.a)(t,["components"]);return Object(o.b)("wrapper",Object(r.a)({},l,n,{components:e,mdxType:"MDXLayout"}),Object(o.b)("p",null,"vmtest is a framework to run ",Object(o.b)("inlineCode",{parentName:"p"},"{cpp,rust,python}_unittest"),"s inside a\ntransparent VM."),Object(o.b)(a.FbInternalOnly,{mdxType:"FbInternalOnly"},"vmtest is commonly used for writing kernel-specific tests in fbcode There exists the need to test kernel features in certain fbcode projects like Tupperware Agent. vmtest is a way to write any unittest in fbcode and have it be executed on multiple different production kernels at once.",Object(o.b)("p",null,"To test across different kernels in fbcode, look at\n",Object(o.b)("inlineCode",{parentName:"p"},"kernel/kernels/kernels.bzl")," for the kernel version selection filters\navailable, so you don't have to maintain a static list of kernels on which to\nrun your test.")),Object(o.b)("p",null,"There are usage examples for each supported language in antlir/vm/tests."),Object(o.b)("h2",{id:"implementation-details"},"Implementation Details"),Object(o.b)("h3",{id:"root-fs"},"Root FS"),Object(o.b)("p",null,"A root filesystem image is built with Antlir and packaged as a BTRFS loopback\ndevice setup as a seed device.\nQEMU is started with two disks: the readonly Antlir-built image and a rw disk\nthat is thrown away after the VM shuts down."),Object(o.b)("h3",{id:"guest-connection"},"Guest connection"),Object(o.b)("p",null,"The VM is started with a virtio-net tap device, and configures a link-local\nIPv6 address. vmtest then controls the guest by connecting to sshd running\ninside the virtual machine."),Object(o.b)("h3",{id:"guest-host-boot-notification"},"Guest->host boot notification"),Object(o.b)("p",null,"To make the SSH connection more reliable, the guest VM is configured to write\nto a virtio-serial port when it is ready for a connection from the host."))}f.isMDXComponent=!0}}]);